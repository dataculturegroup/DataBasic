{% extends "tool_base.html" %}
{% from 'macros.html' import share, hover_tooltip %}

{% macro card_top(type_name, name) -%}
<div class="card-top">
	<h3 class="dragHandle"><span class="glyphicon 
	{% if type_name == 'unicode' %}
		glyphicon-pencil
	{% elif type_name == 'float' or type_name == 'int' or type_name == 'long' or type_name == 'complex' %}
		glyphicon-object-align-bottom
	{% elif type_name == 'datetime' %}
		glyphicon-calendar
	{% elif type_name == 'date' %}
		glyphicon-calendar
	{% elif type_name == 'time' %}
		glyphicon-time
	{% elif type_name == 'bool' %}
		glyphicon-question-sign
	{% else %}
		glyphicon-asterisk
	{% endif %}
	" aria-hidden="true"></span> {{ name }}</h3>
	<div class="close-button"><h3>X</h3></div>
</div>
{%- endmacro %}

{% set column_count = results[index]['columns']|length %}

{% block title %}{{ _('WTFcsv results') }}{% endblock %}

{% block custom_css %}
	<link href="{{ url_for('static', filename='css/wtfcsv-results.scss.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block nav %}
	{% include 'tool_nav.html' %}
{% endblock %}

{% block body %}
<header>
	<div class="container-fluid">
		{% if results|length > 1 %}
		<div class="row centered-row">
	        <div class="col-md-12">
				<ul class="nav nav-tabs nav-justified">
				{% for r in range(results|length) %}
					<li role="presentation" {% if r == index %}class="active"{% endif %}>
						<a href="{{ request.url.replace('/results/' + index|string, '/results/' + r|string) }}">{{ results[r]['sheet_name'] }}</a>
					</li>
				{% endfor %}
				</ul>
			</div>
		</div>
		{% endif %}

		<div class="row">
			<div class="col-md-12" id="intro">
				<h2 id="summary">
				{{_("You have %(rows)s rows of data grouped into %(cols)s columns. Here's some %(metadata)s about each one.", 
				rows=results[index]['row_count'],
				cols=results[index]['columns']|length,
				metadata=hover_tooltip('metadata', 'Metadata summarizes basic information about data to make it easier to discover what\'s going on'))}}
				</h2>
				{{ what_next_anchor() }}
			</div>
			{% if column_count > 6 %}
				<div class="col-md-12">
					<div id="card-position-reference">
						<ul class="nav nav-tabs nav-justified">
							{% for c in range(column_count) %}
								<li class="active" role="presentation">
									<a href="#{{ c }}" id="col-card-{{ c }}" data-toggle="tooltip" class="card-reference" data-original-title="{{ results[index]['columns'][c]['name'] }}"><div class="card-reference-content"></div></a>
								</li>
							{% endfor %}
						</ul>
						{# <div id="additional-options">
							<ul>
							    <li>Show all</li>
							    <li>Hide all</li>
							</ul>
						</div> #}
					</div>
				</div>
			{% endif %}
		</div>
	</div>
</header>

<div class="container-fluid" id="cards">
	<div class="list-group" id="sortableRow">
	{% for c in range(column_count) %}
		
		{% set col=results[index]['columns'][c] %}
		{% set type_name=col['type'] %}
		{% set is_number = 'numbers' in col['display_type_name'] %}
		
		<div class="col-sm-6 col-md-4 list-group-item" id="col-card-{{ c }}">
			<div class="column-info">
				<div class="card" id="card-{{ c }}">
					<div class="front">
						{{ card_top(type_name, col['name']) }}
						<div id="card-chart-{{ c }}"></div>
					</div>
					<div class="back">
						{{ card_top(type_name, col['name']) }}
						<div class="card-bottom">
							<ul>
								<li>{{_("This column is full of")}} {{ col['display_type_name'] }}</li>
								{% if 'values' in col %}
									<li>{{_("The unique values in this column are:")}}
									<ul>
										{% for val in col['values'] %}<li><em>{{val}}</em></li>{% endfor %}
									</ul>
									</li>
								{% elif 'most_freq_values' in col %}
									<li>{{ _("The most frequent values in this column are:") }}
										<ul>
											{% for val in col['most_freq_values'] %}
												{% if is_number %}
												<li><em>{{ val['value'] | replace("_", ".") }}</em><em> ({{ val['count'] }})</em></li>
												{% else %}
													<li><em>{{ val['value'] }}</em><em> ({{ val['count'] }})</em></li>
												{% endif %}
											{% endfor %}
										</ul>
									</li>
								{% endif %}
								{% if 'max_str_len' in col %}
									<li>{{ _("The longest string has %d characters" % col['max_str_len']) }}</li>
								{% endif %}
								{% if 'min' in col %}
									<li>
									{% if type_name == 'datetime' or type_name == 'date' %}
										{{ _('The earliest date is') }}
									{% elif type_name == 'time' %}
										{{ _('The earliest time is') }}
									{% else %}
										{{_("The smallest number is") }} 
									{% endif %} <em>{{col['min']}}</em></li>
								{% endif %}
								{% if 'max' in col %}
									<li>
									{% if type_name == 'datetime' or type_name == 'date' %}
										{{ _('The latest date is') }}
									{% elif type_name == 'time' %}
										{{ _('The latest time is') }}
									{% else %}
										{{_("The biggest number is") }}
									{% endif %} <em>{{col['max']}}</em></li>
								{% endif %}
								{% if 'sum' in col %}
									<li>{{_("The total is") }} <em>{{col['sum']}}</em></li>
								{% endif %}
								{% if 'mean' in col %}
									<li>{{_("The average is") }} <em>{{col['mean']}}</em></li>
								{% endif %}
								{% if 'median' in col %}
									<li>{{_("The median is") }} <em>{{col['median']}}</em></li>
								{% endif %}
								{% if 'stdev' in col %}
									<li>{{_("The standard deviation is") }} <em>{{col['stdev']}}</em></li>
								{% endif %}
								{% if col['nulls'] %}
									<li>{{_("There is missing data in this column")}}</li>
								{% endif %}
								{% if 'freq' in col %}
									<li>{{col['freq']}}</li>
								{% endif %}
								{% if 'len' in col %}
									<li>{{_("The longest string is <em>%d</em> characters" % col['len']) }}</li>
								{% endif %}
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	{% endfor %}
	</div>
	<div class="row">
		<div class="col-md-12">
			{# share() #}
		</div>
	</div>
	{{ what_next() }}
</div>
{% endblock %}
{% block results_scripts %}
<script type="text/javascript" src="https://cdn.rawgit.com/nnattawat/flip/v1.0.18/dist/jquery.flip.min.js"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/lib/highcharts.js') }}"></script>
<script type="text/javascript">

// Uncomment to enable drag & drop
/*Sortable.create(sortableRow, {
  handle: '.dragHandle',
  animation: 150,
  ghostClass: 'ghost'
});*/

// Card flipping
$(".card").flip();

// Card navigation
$('#card-position-reference').affix({
	offset: {
		top: $('#intro').outerHeight(true) + $('.navbar').outerHeight(true)
	}
});

$(document).ready(function(){
	$('#card-position-reference').on('affixed.bs.affix', function(){
		var h = $('#intro').outerHeight(true) + $('#card-position-reference').outerHeight(true)
		$('header').css('min-height', h.toString() + 'px');
	});

	$('.close-button').on('click', function(e){
		var id = $(this).closest('div[class^="col-sm-6"]').attr('id');
		setCardVisible(id, true);
		e.stopPropagation();
	});

	$('.card-reference').on('click', function(e){
		var id = $(this).attr('id');
		setCardVisible(id, !$('.list-group').find('#'+id).hasClass('hidden-card'));
	});

	$('.card')
		.mouseover(function() {
			var id = $(this).closest('div[class^="col-sm-6"]').attr('id');
			var navRef = $('#card-position-reference').find('#' + id);
			navRef.addClass('hover-card');
		})
		.mouseout(function() {
			var id = $(this).closest('div[class^="col-sm-6"]').attr('id');
			var navRef = $('#card-position-reference').find('#' + id);
			navRef.removeClass('hover-card');
		});
});

function setCardVisible(id, hidden) {
	var navRef = $('#card-position-reference').find('#' + id);
	var card = $('.list-group').find('#' + id);
	var navHasHidden = navRef.hasClass('hidden-card');
	var cardHasHidden = card.hasClass('hidden-card');
	if (hidden) {
		if (!navHasHidden)
			navRef.addClass('hidden-card');
		if (!cardHasHidden)
			card.addClass('hidden-card');
	} else {
		if (navHasHidden)
			navRef.removeClass('hidden-card');
		if (cardHasHidden)
			card.removeClass('hidden-card');
	}
}

$(function () {

	Highcharts.theme = {
		colors: ['#fff'],
		chart: {
			backgroundColor: 'none'
		},
		xAxis: {
			gridLineColor: '#fff',
			lineColor: '#fff',
			tickColor: '#fff',
			labels: {
				style: {
					color: '#fff',
					font: '14px HalisGR-Book',
					fontWeight: 'bold'
				}
			},
			title: {
				style: {
					color: '#fff',
					font: '14px HalisGR-Book',
					fontWeight: 'bold'
				}
			}
		},
		yAxis: {
			gridLineColor: '#fff',
			lineColor: '#fff',
			tickColor: '#fff',
			labels: {
				style: {
					color: '#fff',
					font: '14px HalisGR-Book',
					fontWeight: 'bold'
				}
			},
			title: {
				style: {
					color: '#fff',
					font: '14px HalisGR-Book',
					fontWeight: 'bold'
				}
			}
		}
	}

	var highchartsOptions = Highcharts.setOptions(Highcharts.theme);

{% for c in range(column_count) %}
{% set col=results[index]['columns'][c] %}
{% set dname=col['display_type_name'] %}
	$('#card-chart-{{ c }}').highcharts({
		{% if 'text' in dname or 'numbers' in dname or 'dates' in dname or 'times' in dname or 'dates and times' in dname %}
			title: {
				text: null
			},
			tooltip: {
				enabled: false
			},
			{% if 'text' in dname or 'numbers' in dname %}
				chart: {
					type: 'column'
				},
			{% endif %}
			xAxis: {
				title: {
					text:
					{% if 'text' in dname %}
					_('Categories')
					{% elif 'numbers' in dname %}
					_('Counts')
					{% elif 'dates' %}
					_('Dates')
					{% elif 'times' %}
					_('Times')
					{% elif 'dates and times' %}
					_('Dates and times')
					{% else %}
					_('Undefined')
					{% endif %}
				},
				categories: [
					{% if 'most_freq_values' in col %}
						{{ get_most_freq(col['most_freq_values'], 'value', dname) }}
					{% endif %}
				],
				plotLines: [{
					color: '#fff'
				}]
			},
			yAxis: {
				title: {
					text: _('Values')
				},
				plotLines: [{
					color: '#fff'
				}]
			},
			plotOptions: {
			    column: {
			        pointPadding: 0,
			        borderWidth: 0,
			        groupPadding: 0,
			        shadow: false
			    }
			},
			series: [{
				data: [
					{% if 'most_freq_values' in col %}
						{{ get_most_freq(col['most_freq_values'], 'count', dname) }}
					{% endif %}
				],
				showInLegend: false,
				marker: {
					states: {
						hover: {
							enabled: false
						}
					}
				}
			}],
			credits: {
				enabled: false
			}
		{% endif %}
	});
	
{% endfor %}
});

</script>
{% endblock %}

{% macro get_most_freq(most_freq_values, key, displayName) %}
	{% set is_string = 'text' in displayName %}
	{% for val in most_freq_values %}
		{% if 'value' in key %}
			{% if is_string %}
				"{{ val[key]|string }}",
			{% else %}
				{{ val[key]|replace('_', '.') }},
			{% endif %}
		{% else %}
			{{ val[key] }},
		{% endif %}
	{% endfor %}
{% endmacro %}